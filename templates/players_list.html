<!-- templates/players_list.html -->

{% extends 'base.html' %}

{% block content %}
<h2>Players</h2>
<div class="filter-options">
  <input type="text" id="searchInput" placeholder="Search..." onkeyup="filterList()">
</div>
<div id="dataList">
  {% for player in data %}
  <div class="data-container">
    <div class="data-bar">
      <!-- Display Player Name with Correct Object ID for URL -->
      <div class="player-info">
        <button class="team-button" onclick="window.location.href='{{ url_for('player_detail', object_id=player['_id']|string) }}'">
          {{ player.get('summoner_names', ['Unknown Player'])[0] }}
        </button>
        {% if player.current_teams %}
        <!-- Display Current Team as Button with Split-Division Format -->
        {% for team in player.current_teams %}
        <button class="team-info-button" onclick="window.location.href='{{ url_for('team_detail', object_id=team['_id']) }}'">
          {{ team['team_name'] }} ({{ team['split'] }} - {{ team['division'] }})
        </button>
        {% endfor %}
        {% endif %}
      </div>

      <div class="details-frame-group">
        <!-- Display Top 5 Most Played Champions with Correct Icons -->
        {% set sorted_champions = player.get('champions_played', {}).items() | sort(attribute='1', reverse=true) %}
        <div class="champions-container">
          {% for champ, count in sorted_champions[:5] %}
          <div class="champion-frame">
            <img class="champion-icon" src="https://ddragon.leagueoflegends.com/cdn/latest/img/champion/{{ champ | replace(' ', '') }}.png" alt="{{ champ }}">
            <span class="champion-count">{{ count }}</span>
          </div>
          {% endfor %}
        </div>

        <!-- Display Average Stats in Frames Below the Champion Icons -->
        <div class="stats-container">
          <div class="stats-frame">Kills: {{ player.average_stats.kills | round(1) | default('N/A') }}</div>
          <div class="stats-frame">Deaths: {{ player.average_stats.deaths | round(1) | default('N/A') }}</div>
          <div class="stats-frame">Assists: {{ player.average_stats.assists | round(1) | default('N/A') }}</div>
          <div class="stats-frame">Damage Dealt: {{ ((player.average_stats.total_damage_dealt_to_champions | default(0)) / 1000) | round(2) | round(1) }}K</div>
          <div class="stats-frame">Damage Taken: {{ ((player.average_stats.total_damage_taken | default(0)) / 1000) | round(2) | round(1) }}K</div>
          <div class="stats-frame">Gold Earned: {{ ((player.average_stats.gold_earned | default(0)) / 1000) | round(2) | round(1) }}K</div>
          <div class="stats-frame">Minions Killed: {{ player.average_stats.total_minions_killed | round(1) | default('N/A') }}</div>
          <div class="stats-frame">Vision Score: {{ player.average_stats.vision_score | round(1) | default('N/A') }}</div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<script>
  async function loadGameData() {
    try {
      // Fetch latest version for accurate icon URLs
      const versionResponse = await fetch('https://ddragon.leagueoflegends.com/api/versions.json');
      const versions = await versionResponse.json();
      const latestVersion = versions[0];
      document.querySelectorAll('.champion-icon').forEach(img => {
        const championName = img.alt.replace(' ', '');
        img.src = `https://ddragon.leagueoflegends.com/cdn/${latestVersion}/img/champion/${championName}.png`;
      });
    } catch (error) {
      console.error('Error fetching game data:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', loadGameData);

  function filterList() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const dataBars = document.querySelectorAll('.data-bar');

    dataBars.forEach(bar => {
      const textValue = bar.textContent || bar.innerText;
      bar.style.display = textValue.toLowerCase().indexOf(filter) > -1 ? '' : 'none';
    });
  }
</script>

<style>
  .data-container {
    margin-bottom: 15px;
  }

  .data-bar {
    padding: 10px;
    border: 1px solid #ccc;
    margin: 5px 0;
    background-color: #f9f9f9;
    border-radius: 5px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .data-bar:hover {
    background-color: #e0e0e0;
  }

  .player-info {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .team-button {
    padding: 5px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
  }

  .team-info-button {
    padding: 5px 10px;
    border: none;
    border-radius: 5px;
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    font-size: 12px;
    margin-left: 5px;
  }

  .team-info-button:hover {
    background-color: #45a049;
  }

  .details-frame-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .champions-container {
    display: flex;
    gap: 10px;
  }

  .champion-frame {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 50px;
    height: 60px;
    border: 1px solid #ccc;
    border-radius: 5px;
    background-color: #f4f4f4;
    padding: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .champion-icon {
    width: 48px;
    height: 48px;
    border-radius: 5px;
  }

  .champion-count {
    margin-top: 2px;
    margin-bottom: 2px;
    font-size: 12px;
    font-weight: bold;
    text-align: center;
  }

  .stats-container {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .stats-frame {
    width: 48px;
    height: 48px;
    border: 1px solid #ccc;
    border-radius: 5px;
    background-color: #333;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    text-decoration: none;
  }
</style>
{% endblock %}
