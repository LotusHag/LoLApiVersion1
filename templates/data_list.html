<!-- templates/data_list.html -->

{% extends 'base.html' %}

{% block content %}
<h2>{{ data_type.capitalize() }}</h2>
<div class="filter-options">
  <input type="text" id="searchInput" placeholder="Search..." onkeyup="filterList()">
</div>
<div id="dataList">
  {% for item in data %}
  <div class="data-container">
    <div class="data-bar" onclick="toggleDetails('{{ item['_id'] }}', '{{ data_type }}')">
      <span class="data-summary">
        {% if data_type == 'matches' %}
          {% if item.get('teams') and item['teams'][0] and item['teams'][1] %}
            <button class="team-button {{ 'winner' if item['teams'][0]['win'] else 'loser' }}" 
                    onclick="event.stopPropagation(); window.location.href='{{ url_for('data_detail', data_type='teams', object_id=item['teams'][0]['_id']|string) }}'">
              {{ item['teams'][0]['team_name'] }}
            </button>
            vs
            <button class="team-button {{ 'winner' if item['teams'][1]['win'] else 'loser' }}" 
                    onclick="event.stopPropagation(); window.location.href='{{ url_for('data_detail', data_type='teams', object_id=item['teams'][1]['_id']|string) }}'">
              {{ item['teams'][1]['team_name'] }}
            </button>
            on {{ item.get('date', 'Date not available') }}
          {% else %}
            <span>Teams data is missing</span>
          {% endif %}
        {% elif data_type == 'players' %}
          <a href="{{ url_for('data_detail', data_type='players', object_id=item['_id']) }}">
            {{ item.get('summoner_names', ['Unknown Player'])[0] }}
          </a>
        {% elif data_type == 'teams' %}
          <a href="{{ url_for('data_detail', data_type='teams', object_id=item['_id']) }}">
            {{ item.get('team_name', 'Unknown Team') }}
          </a>
        {% endif %}
      </span>
      <button class="details-button" onclick="event.stopPropagation(); window.location.href='{{ url_for('data_detail', data_type=data_type, object_id=item['_id']) }}'">
        More Details
      </button>
    </div>
    <div id="details-{{ item['_id'] }}" class="data-details" style="display: none;">
      {% if data_type == 'players' %}
        <div class="player-stats">
          <h4>Average Stats:</h4>
          <ul>
            <li><strong>Kills:</strong> {{ item['average_stats'].kills | default('N/A') }}</li>
            <li><strong>Deaths:</strong> {{ item['average_stats'].deaths | default('N/A') }}</li>
            <li><strong>Assists:</strong> {{ item['average_stats'].assists | default('N/A') }}</li>
            <li><strong>Total Damage Dealt to Champions:</strong> {{ item['average_stats'].total_damage_dealt_to_champions | default('N/A') }}</li>
            <li><strong>Total Damage Taken:</strong> {{ item['average_stats'].total_damage_taken | default('N/A') }}</li>
            <li><strong>Gold Earned:</strong> {{ item['average_stats'].gold_earned | default('N/A') }}</li>
            <li><strong>Vision Score:</strong> {{ item['average_stats'].vision_score | default('N/A') }}</li>
          </ul>
        </div>
      {% elif data_type == 'teams' %}
        <div class="team-stats">
          <h4>Current Roster:</h4>
          <ul>
            {% for player in item.current_roster %}
              <li>{{ player.summoner_names[0] if player else 'Unknown Player' }}</li>
            {% endfor %}
          </ul>
          <h4>Last 10 Matches:</h4>
          <ul>
            {% for match in item.match_history %}
              <li class="{{ 'winner' if match and match['teams'] and (match['teams'][0]['win'] and match['teams'][0]['team_name'] == item['team_name'] or match['teams'][1]['win'] and match['teams'][1]['team_name'] == item['team_name']) else 'loser' }}">
                {{ match['teams'][0]['team_name'] }} vs {{ match['teams'][1]['team_name'] }} - {{ 'Win' if match and match['teams'] and (match['teams'][0]['win'] and match['teams'][0]['team_name'] == item['team_name'] or match['teams'][1]['win'] and match['teams'][1]['team_name'] == item['team_name']) else 'Loss' }}
              </li>
            {% else %}
              <li>Match data not available</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<script>
  let championMap = {};
  let itemMap = {};
  let latestVersion = "";

  // Fetch latest version and then champions and items list dynamically
  async function loadGameData() {
    try {
      const versionResponse = await fetch('https://ddragon.leagueoflegends.com/api/versions.json');
      const versions = await versionResponse.json();
      latestVersion = versions[0];

      // Fetch champions and items data from Data Dragon
      const championResponse = await fetch(`https://ddragon.leagueoflegends.com/cdn/${latestVersion}/data/en_US/champion.json`);
      const championData = await championResponse.json();
      const itemResponse = await fetch(`https://ddragon.leagueoflegends.com/cdn/${latestVersion}/data/en_US/item.json`);
      const itemData = await itemResponse.json();

      // Create mappings for champions and items
      Object.values(championData.data).forEach(champion => {
        championMap[parseInt(champion.key)] = champion.id;
      });

      Object.entries(itemData.data).forEach(([id, item]) => {
        itemMap[parseInt(id)] = item.image.full;
      });

      console.log("Game data loaded successfully.");
    } catch (error) {
      console.error('Error fetching game data:', error);
    }
  }

  // Initialize game data on page load
  document.addEventListener('DOMContentLoaded', loadGameData);

  function filterList() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const dataBars = document.querySelectorAll('.data-bar');

    dataBars.forEach(bar => {
      const textValue = bar.textContent || bar.innerText;
      bar.style.display = textValue.toLowerCase().indexOf(filter) > -1 ? '' : 'none';
    });
  }

  function toggleDetails(itemId, dataType) {
    const details = document.getElementById(`details-${itemId}`);
    if (details.style.display === 'none' || details.style.display === '') {
      if (dataType === 'matches') {
        fetchMatchDetails(itemId, details);
      } else {
        details.style.display = 'block';
      }
    } else {
      details.style.display = 'none';
    }
  }

  function fetchMatchDetails(matchId, container) {
    fetch(`/fetch_match_details/${matchId}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          container.innerHTML = `<p>${data.error}</p>`;
        } else {
          const blueTeam = data.players.filter(p => p.team_id === 100).sort((a, b) => a.individual_position.localeCompare(b.individual_position));
          const redTeam = data.players.filter(p => p.team_id === 200).sort((a, b) => a.individual_position.localeCompare(b.individual_position));
          const positions = ["TOP", "JUNGLE", "MIDDLE", "BOTTOM", "UTILITY"];

          container.innerHTML = `
            <div class="teams-container">
              <div class="team blue-team">
                <div class="bans-container">
                  ${data.teams[0].bans.map(ban => renderBanIcon(ban)).join('')}
                  <span class="${data.teams[0].win ? 'winner-label' : 'loser-label'}">
                    ${data.teams[0].win ? 'Winner' : 'Loser'}
                  </span>
                </div>
                <div class="players-grid">
                  ${positions.map(position => {
                    const player = blueTeam.find(p => p.individual_position === position);
                    if (player) {
                      return renderPlayer(player);
                    } else {
                      return `<div class="player-box empty">No player data</div>`;
                    }
                  }).join('')}
                </div>
              </div>
              <div class="team red-team">
                <div class="bans-container">
                  ${data.teams[1].bans.map(ban => renderBanIcon(ban)).join('')}
                  <span class="${data.teams[1].win ? 'winner-label' : 'loser-label'}">
                    ${data.teams[1].win ? 'Winner' : 'Loser'}
                  </span>
                </div>
                <div class="players-grid">
                  ${positions.map(position => {
                    const player = redTeam.find(p => p.individual_position === position);
                    if (player) {
                      return renderPlayer(player);
                    } else {
                      return `<div class="player-box empty">No player data</div>`;
                    }
                  }).join('')}
                </div>
              </div>
            </div>
          `;
        }
        container.style.display = 'block';
      })
      .catch(error => {
        container.innerHTML = `<p>Error fetching match details: ${error}</p>`;
        container.style.display = 'block';
      });
  }

  function renderPlayer(player) {
    // Fetch player's item IDs and render them correctly
    const items = [player.item0, player.item1, player.item2, player.item3, player.item4, player.item5]
      .map(itemId => renderItemIcon(itemId))
      .join('');
    return `
      <div class="player-box">
        <div class="champion-and-items">
          <img class="champion-icon" src="${getChampionIconURL(player.champion_id)}" alt="${player.champion_id}" onerror="this.onerror=null; this.src='/static/images/placeholder.png';">
          <div class="items-grid">
            ${items}
          </div>
        </div>
        <div class="player-info">
          <a href="/general_data/players/${player.summoner_id}" class="player-name">${player.summoner_name}</a>
          <div class="player-stats">
            <span>KDA: ${player.kills}/${player.deaths}/${player.assists}</span>
            <span>Gold: ${player.gold_earned}</span>
            <span>Damage: ${formatDamage(player.total_damage_dealt_to_champions)}</span>
            <span>Vision: ${player.vision_score}</span>
          </div>
        </div>
      </div>
    `;
  }

  function renderBanIcon(ban) {
    return `<img class="ban-icon" src="${getChampionIconURL(ban)}" alt="Champion ${ban}" onerror="this.onerror=null; this.src='/static/images/placeholder.png';">`;
  }

  function renderItemIcon(itemId) {
    const itemIcon = itemMap[itemId];
    if (itemIcon) {
      return `<img class="item-icon" src="https://ddragon.leagueoflegends.com/cdn/${latestVersion}/img/item/${itemIcon}" alt="Item ${itemId}" onerror="this.onerror=null; this.src='/static/images/placeholder.png';">`;
    }
    return `<div class="item-icon empty"></div>`;
  }

  function getChampionIconURL(championId) {
    const championName = championMap[championId];
    // Try using champion name if available; fallback to generic or handle errors gracefully
    return championName ? 
      `https://ddragon.leagueoflegends.com/cdn/${latestVersion}/img/champion/${championName}.png` : 
      `https://ddragon.leagueoflegends.com/cdn/${latestVersion}/img/champion/${championId}.png`;
  }

  function formatDamage(damage) {
    return (damage / 1000).toFixed(1) + 'K';
  }
</script>

<style>
  .data-container {
    margin-bottom: 15px;
  }

  .data-bar {
    padding: 10px;
    border: 1px solid #ccc;
    margin: 5px 0;
    cursor: pointer;
    background-color: #f9f9f9;
    border-radius: 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
  }

  .data-bar:hover {
    background-color: #e0e0e0;
  }

  .data-summary {
    flex-grow: 1;
  }

  .details-button {
    padding: 5px 10px;
    background-color: #007BFF;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
  }

  .details-button:hover {
    background-color: #0056b3;
  }

  .team-button {
    padding: 5px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    margin: 0 5px;
  }

  .winner {
    background-color: #d4edda;
    color: #155724;
  }

  .loser {
    background-color: #f8d7da;
    color: #721c24;
  }

  .data-details {
    padding: 10px;
    border-top: 1px solid #ddd;
    display: none;
    margin-top: 10px;
  }

  .teams-container {
    display: flex;
    justify-content: space-between;
    gap: 20px;
  }

  .team {
    width: 48%;
  }

  .blue-team {
    background-color: #e0f7ff;
    padding: 10px;
    border-radius: 5px;
  }

  .red-team {
    background-color: #ffe0e0;
    padding: 10px;
    border-radius: 5px;
  }

  .bans-container {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 10px;
    align-items: center.
  }

  .ban-icon {
    width: 48px;
    height: 48px;
    border: 2px solid #333;
    border-radius: 5px.
  }

  .winner-label {
    color: green;
    font-weight: bold;
    margin-left: 10px.
  }

  .loser-label {
    color: red;
    font-weight: bold;
    margin-left: 10px.
  }

  .players-grid {
    display: grid;
    gap: 10px.
  }

  .player-box {
    display: flex;
    background-color: #fff;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    align-items: center;
    width: 100%.
  }

  .champion-and-items {
    display: flex;
    flex-direction: column;
    align-items: center.
  }

  .champion-icon {
    width: 60px;
    height: 60px;
    margin-bottom: 5px.
  }

  .items-grid {
    display: grid;
    grid-template-columns: repeat(3, 24px);
    grid-template-rows: repeat(2, 24px);
    gap: 2px.
  }

  .item-icon {
    width: 24px;
    height: 24px;
    border: 1px solid #ccc;
    border-radius: 3px.
  }

  .item-icon.empty {
    background-color: #e0e0e0.
  }

  .player-info {
    margin-left: 10px;
    flex-grow: 1.
  }

  .player-name {
    display: block;
    font-weight: bold;
    margin-bottom: 5px.
    text-decoration: none.
    color: #333.
  }

  .player-name:hover {
    text-decoration: underline.
  }

  .player-stats {
    display: flex.
    flex-direction: column.
    gap: 4px.
  }
</style>
{% endblock %}
